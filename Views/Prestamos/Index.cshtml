@model List<BibliotecaWeb.Models.Prestamo>
@{
    ViewData["Title"] = "Mis Pr√©stamos";
}

<div class="container mt-4">
    <h2>üìí Mis Pr√©stamos</h2>

    <!-- ALERTA DE SANCIONES -->
    @if (ViewBag.EstaSancionado)
    {
        <div class="alert alert-danger">
            <h5>üö´ Usuario Sancionado</h5>
            <p>Tienes <strong>@ViewBag.Sanciones sanciones</strong>. No puedes solicitar nuevos pr√©stamos hasta que se levante la sanci√≥n.</p>
            @if (ViewBag.Usuario?.FechaFinSancion != null)
            {
                <p class="mb-0">üìÖ Sanci√≥n activa hasta: <strong>@ViewBag.Usuario.FechaFinSancion.ToString("dd/MM/yyyy")</strong></p>
            }
        </div>
    }
    else if (ViewBag.Sanciones > 0)
    {
        <div class="alert alert-warning">
            <h5>‚ö†Ô∏è Sanciones Activas</h5>
            <p>Tienes <strong>@ViewBag.Sanciones sanciones de 3</strong>. 
               <a href="/Prestamos/Sanciones" class="alert-link">Ver detalles</a>
            </p>
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@Html.Raw(TempData["Success"])</div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@Html.Raw(TempData["Error"])</div>
    }

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            No tienes pr√©stamos activos.
        </div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Libro</th>
                    <th>Fecha Pr√©stamo</th>
                    <th>Vence el</th>
                    <th>Hora L√≠mite</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var prestamo in Model)
                {
                    var estaRetrasado = prestamo.Estado == "Activo" && prestamo.FechaVencimiento < DateTime.Now;
                    var horaVencimiento = prestamo.FechaVencimiento.ToString("HH:mm");
                    <tr class="@(estaRetrasado ? "table-danger" : "")">
                        <td>
                            <strong>@prestamo.Libro.Titulo</strong><br>
                            <small class="text-muted">@prestamo.Libro.Autor</small>
                            @if (prestamo.TieneSancion)
                            {
                                <br><small class="text-danger">‚ö†Ô∏è Con sanci√≥n</small>
                            }
                        </td>
                        <td>@prestamo.FechaPrestamo.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>
                            <strong>@prestamo.FechaVencimiento.ToString("dd/MM/yyyy")</strong>
                            @if (estaRetrasado)
                            {
                                <br><small class="text-danger">‚ö†Ô∏è RETRASADO</small>
                            }
                        </td>
                        <td>
                            <strong>@horaVencimiento</strong>
                        </td>
                        <td>
                            @if (prestamo.Estado == "Activo")
                            {
                                <span class="badge badge-warning">@prestamo.Estado</span>
                            }
                            else if (prestamo.Estado == "Retrasado")
                            {
                                <span class="badge badge-danger">@prestamo.Estado</span>
                            }
                            else
                            {
                                <span class="badge badge-success">@prestamo.Estado</span>
                            }
                        </td>
                        <td>
                            @if (prestamo.Estado == "Activo" || prestamo.Estado == "Retrasado")
                            {
                                <a href="/Prestamos/Devolver/@prestamo.PrestamoID" 
                                   class="btn btn-success btn-sm" 
                                   onclick="return confirm('¬øEst√°s seguro de devolver este libro?')">
                                    üì§ Devolver
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">Finalizado</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <div class="mt-3">
        @if (!ViewBag.EstaSancionado)
        {
            <a href="/Prestamos/Create" class="btn btn-primary">üì• Solicitar Nuevo Pr√©stamo</a>
        }
        <a href="/Libros" class="btn btn-info">üìö Ver Todos los Libros</a>
        <a href="/Prestamos/Sanciones" class="btn btn-warning">‚ö†Ô∏è Mis Sanciones</a>
        <a href="/Home" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
    </div>
</div>